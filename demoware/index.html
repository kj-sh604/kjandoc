<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>slide merging demoware</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kj-sh604/noir.css@latest/out/noir.min.css">
    <style>
        .file-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; } .file-item button { padding: 0.15rem 0.5rem; margin: 0; font-size: 0.85rem; min-width: 2rem; } .file-item .fname { flex: 1; font-family: var(--font-family, monospace); } #drop-zone { border: 2px dashed #555; padding: 2rem; text-align: center; border-radius: 6px; margin: 1rem 0; cursor: pointer; transition: border-color 0.15s, background 0.15s; } #drop-zone.over { border-color: #7ec8e3; background: rgba(126, 200, 227, 0.06); } #command-display { white-space: pre-wrap; word-break: break-all; } .hidden { display: none !important; } .running { color: #ff9800; } .done    { color: #4caf50; } .error   { color: #f44336; } #log-output { max-height: 300px; overflow-y: auto; font-size: 0.85rem; } footer { margin-top: 2rem; }
    </style>
</head>
<body>
    <h1>an attempt at a .pptx merging tool</h1>
    <p>merge multiple <code>.pptx</code> files into a <em>single</em> <code>.pptx</code> file.</p>
    <hr>

    <h2>1. add files</h2>
    <div id="drop-zone">
        drop <code>.pptx</code> files here
    </div>
    <input type="file" id="file-input" multiple accept=".pptx" style="margin-top:0.5rem;">

    <h2>2. merge order</h2>
    <p id="empty-msg"><em>no files added yet.</em></p>
    <div id="file-list"></div>

    <h2>3. merge</h2>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
        <button id="merge-btn" disabled title="renders slides as images via libreoffice + pdftoppm, then rebuilds a new deck.">merge (non-editable)</button>
        <button id="merge-st-btn" disabled title="re-generates a new .pptx with editability preserved (requires that all Powerpoints share the same template)">concatenate (if same template)</button>
    </div>

    <div id="cmd-section" class="hidden">
        <h3>command being used:</h3>
        <pre id="command-display"></pre>
    </div>

    <div id="status-section" class="hidden">
        <p id="status-msg"></p>
        <pre id="log-output" class="hidden"></pre>
    </div>

    <div id="dl-section" class="hidden">
        <a id="dl-link"><button>⬇ download .pptx</button></a>
    </div>

    <footer>
        <small>powered with <a href="https://github.com/kj-sh604/kjandoc" target="_blank" rel="noopener">kjandoc</a> by <a href="https://github.com/kj-sh604" target="_blank" rel="noopener">kj_sh604</a></small>
    </footer>

    <script>
(() => {
    "use strict";

    let files = [];
    let nextId = 1;
    let merging = false;

    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("file-input");
    const fileList = document.getElementById("file-list");
    const emptyMsg = document.getElementById("empty-msg");
    const mergeBtn = document.getElementById("merge-btn");
    const mergeStBtn = document.getElementById("merge-st-btn");
    const cmdSection = document.getElementById("cmd-section");
    const cmdDisplay = document.getElementById("command-display");
    const statusSection = document.getElementById("status-section");
    const statusMsg = document.getElementById("status-msg");
    const logOutput = document.getElementById("log-output");
    const dlSection = document.getElementById("dl-section");
    const dlLink = document.getElementById("dl-link");

    function addFiles(inputFiles) {
        for (const f of inputFiles)
            if (f.name.toLowerCase().endsWith(".pptx"))
                files.push({ id: nextId++, name: f.name, file: f });
        renderList();
    }

    function renderList() {
        fileList.innerHTML = "";
        if (files.length === 0) {
            emptyMsg.classList.remove("hidden");
            mergeBtn.disabled = true;
            mergeStBtn.disabled = true;
            return;
        }
        emptyMsg.classList.add("hidden");
        mergeBtn.disabled = merging;
        mergeStBtn.disabled = merging;

        files.forEach((f, idx) => {
            const row = document.createElement("div");
            row.className = "file-item";

            const up = makeBtn("\u25b2", idx === 0, () => swap(idx, idx - 1));
            const dn = makeBtn("\u25bc", idx === files.length - 1, () => swap(idx, idx + 1));
            const rm = makeBtn("\u2715", false, () => { files.splice(idx, 1); renderList(); });

            const label = document.createElement("span");
            label.className = "fname";
            label.textContent = (idx + 1) + ". " + f.name;

            row.append(up, dn, rm, label);
            fileList.appendChild(row);
        });
    }

    function makeBtn(text, disabled, onclick) {
        const btn = document.createElement("button");
        btn.textContent = text;
        btn.disabled = disabled;
        btn.onclick = onclick;
        return btn;
    }

    function swap(a, b) {
        [files[a], files[b]] = [files[b], files[a]];
        renderList();
    }

    // drag & drop + file input
    fileInput.addEventListener("change", () => { addFiles(fileInput.files); fileInput.value = ""; });
    dropZone.addEventListener("dragover", (ev) => { ev.preventDefault(); dropZone.classList.add("over"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("over"));
    dropZone.addEventListener("drop", (ev) => { ev.preventDefault(); dropZone.classList.remove("over"); addFiles(ev.dataTransfer.files); });
    dropZone.addEventListener("click", () => fileInput.click());

    // shared merge logic — mode is "render" (kjandoc) or "same-template" (kjandoc-st)
    async function doMerge(mode) {
        if (files.length === 0 || merging) return;

        merging = true;
        mergeBtn.disabled = true;
        mergeStBtn.disabled = true;
        cmdSection.classList.add("hidden");
        statusSection.classList.add("hidden");
        dlSection.classList.add("hidden");
        logOutput.textContent = "";
        logOutput.classList.add("hidden");

        const jobId = Date.now() + "_" + Math.random().toString(36).substring(2, 10);

        statusSection.classList.remove("hidden");

        // upload files
        for (let i = 0; i < files.length; i++) {
            const f = files[i];
            statusMsg.textContent = "uploading " + (i + 1) + "/" + files.length + ": " + f.name;
            statusMsg.className = "running";

            const uploadName = f.id + "_" + f.name;
            try {
                const res = await fetch("/api/upload", {
                    method: "POST",
                    headers: { "X-Job-Id": jobId, "X-Filename": encodeURIComponent(uploadName) },
                    body: f.file,
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: "upload failed" }));
                    throw new Error(err.error);
                }
            } catch (err) {
                statusMsg.textContent = "upload error: " + err.message;
                statusMsg.className = "error";
                merging = false;
                mergeBtn.disabled = false;
                mergeStBtn.disabled = false;
                return;
            }
        }

        statusMsg.textContent = "starting merge...";

        const fileNames = files.map((f) => f.id + "_" + f.name);
        let mergeResult;

        try {
            const res = await fetch("/api/merge", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ job_id: jobId, files: fileNames, mode: mode }),
            });
            mergeResult = await res.json();
            if (!res.ok) throw new Error(mergeResult.error || "merge failed");
        } catch (err) {
            statusMsg.textContent = "merge error: " + err.message;
            statusMsg.className = "error";
            merging = false;
            mergeBtn.disabled = false;
            mergeStBtn.disabled = false;
            return;
        }

        cmdSection.classList.remove("hidden");
        cmdDisplay.textContent = "$ " + mergeResult.command;
        statusMsg.textContent = "processing... this may take a while depending on slide count.";

        const poll = setInterval(async () => {
            try {
                const res = await fetch("/api/status/" + jobId);
                const data = await res.json();

                if (data.log) {
                    logOutput.classList.remove("hidden");
                    logOutput.textContent = data.log;
                }

                if (data.status === "done") {
                    clearInterval(poll);
                    statusMsg.textContent = "process complete!";
                    statusMsg.className = "done";
                    dlSection.classList.remove("hidden");
                    dlLink.href = "/output/" + mergeResult.output;
                    dlLink.download = mergeResult.output;
                    merging = false;
                    mergeBtn.disabled = false;
                    mergeStBtn.disabled = false;
                } else if (data.status === "error") {
                    clearInterval(poll);
                    statusMsg.textContent = "process failed \u2014 check the log below.";
                    statusMsg.className = "error";
                    merging = false;
                    mergeBtn.disabled = false;
                    mergeStBtn.disabled = false;
                }
            } catch (err) {}
        }, 2000);
    }

    mergeBtn.addEventListener("click", () => doMerge("render"));
    mergeStBtn.addEventListener("click", () => doMerge("same-template"));
})();
    </script>
</body>
</html>
